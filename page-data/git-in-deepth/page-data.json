{"componentChunkName":"component---src-templates-blog-post-js","path":"/git-in-deepth/","result":{"data":{"site":{"siteMetadata":{"title":"feiker的小站"}},"markdownRemark":{"id":"fc906ac7-cd72-5dee-ae9e-47a24601ecb2","excerpt":"git (分布式版本管理系统) 是目前使用最广泛的一个版本控制系统，知其然以及知其所以然能帮助我们在开发过程中快速定位问题。 git 底层 git 是一个内容寻址文件系统，核心部分就是一个简单的 key-value 键值数据库，key 是一个 sha1 计算后的 hash 串，value 是压缩后的数据文件(blob…","html":"<p>git (分布式版本管理系统) 是目前使用最广泛的一个版本控制系统，知其然以及知其所以然能帮助我们在开发过程中快速定位问题。</p>\n<h4>git 底层</h4>\n<p>git 是一个内容寻址文件系统，核心部分就是一个简单的 key-value 键值数据库，key 是一个 sha1 计算后的 hash 串，value 是压缩后的数据文件(blob)。</p>\n<h4>blob</h4>\n<p>git 仓库的所有文件都是用 blob(二进制数据文件)存储的，文件内容存储在.git/objects， 以文件内容的hash值前两位作为目录名，hash2位后作为文件名</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/b2ef4023a3ae8e6fe2b0afa1062c4c01/99445/image-20191212174229961.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.88469601677149%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABE0lEQVQ4y5WT226DMBBE+f8/pIAQ6kO5GV8wF6nA1ON2ozwkTWxptMbWHg9rb/alR3z0PT69h7In1rbHt7VY9w2LX2CMwTzPuK4LHBKfjcxqAzMpOKPhZwu/rjAB6KyLIBvmPhwmsJdAJk1aow8uu47q0LVtjL9rHXTYfxtIB9M0YRzHCBiG4RZl7pxLc8g6CVCcCZDrPDQJyASl1M0RJd/JQBacUAL465TMCaO4nwRkjZgoQIEJPBnIBN4kJe7uYxJQash66b/nQ3dST17Soxo+A2ePLoSQ++cjwHdcZnwyBCzLEjuCkVpDx1Bc2/cdx3FEvXR4nifa0BlN0yDPc5RliaqqUBRFjFRd13GPcdu2f4E/wDDwG0z8lxgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20191212174229961\"\n        title=\"image-20191212174229961\"\n        src=\"/blog/static/b2ef4023a3ae8e6fe2b0afa1062c4c01/b9e4f/image-20191212174229961.png\"\n        srcset=\"/blog/static/b2ef4023a3ae8e6fe2b0afa1062c4c01/cf440/image-20191212174229961.png 148w,\n/blog/static/b2ef4023a3ae8e6fe2b0afa1062c4c01/d2d38/image-20191212174229961.png 295w,\n/blog/static/b2ef4023a3ae8e6fe2b0afa1062c4c01/b9e4f/image-20191212174229961.png 590w,\n/blog/static/b2ef4023a3ae8e6fe2b0afa1062c4c01/f9b6a/image-20191212174229961.png 885w,\n/blog/static/b2ef4023a3ae8e6fe2b0afa1062c4c01/2d849/image-20191212174229961.png 1180w,\n/blog/static/b2ef4023a3ae8e6fe2b0afa1062c4c01/99445/image-20191212174229961.png 1908w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>git 以 <code class=\"language-text\">blob ${文件大小} \\0 ${文件内容}</code> 来计算 hash，通过以下验证</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'test'</span> <span class=\"token operator\">|</span> <span class=\"token function\">git</span> hash-object --stdin\n9daeafb9864cf43055ae93beb0afd6c7d144bfa4\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'blob 5<span class=\"token entity\" title=\"\\0\">\\0</span>test'</span> <span class=\"token operator\">|</span> openssl sha1\n9daeafb9864cf43055ae93beb0afd6c7d144bfa4</code></pre></div>\n<p>可以看到文本 test 通过 git 计算的 hash 和文本<code class=\"language-text\">blob 5\\0test</code> 在 sha1 计算的 hash 值一样</p>\n<h4>tree</h4>\n<p>把文件cat出来，发现是一堆乱码，那是因为blob文件是被压缩过的，文件的头stat信息以及文件组织结构都被丢失了。</p>\n<p>git用tree来保存这些信息，一个tree包括了</p>\n<ul>\n<li>指向其它tree或者blob的指针</li>\n<li>指针类型（它是tree还是blob）</li>\n<li>文件名</li>\n<li>文件权限（可读，可些，可执行）</li>\n</ul>\n<p>可以把master分支上最新提交所指向的树对象打印出来看看</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> cat-file -p master^<span class=\"token punctuation\">{</span>tree<span class=\"token punctuation\">}</span>\n\n<span class=\"token number\">100644</span> blob 87adace1aa1660900f66db4db04afceb1c9973cd\t.gitignore\n<span class=\"token number\">100644</span> blob 5312291951904c9402e5b2ef79f3e7d5591e60df\tTODO.md\n040000 tree d5633113208cb719f0756b122b049f0fb0e1fc6c\tdist\n040000 tree ba509bd56e0c77ed2581e78c754535d323f7c47b\texample\n<span class=\"token number\">100644</span> blob bc3140ee20e132f81fbe67c49f4cfdffcbb7d7e3\tpackage-lock.json\n<span class=\"token number\">100644</span> blob 15861951236a4b10137918c87bbde51553e50c4b\tpackage.json\n040000 tree f27cd1e5968a1d240c3779ee4fd0bcb588f388b5\tsrc\n<span class=\"token number\">100644</span> blob e18e7f8d08f47ea47c97725b3eac5d0df80dcbdd\ttsconfig.json</code></pre></div>\n<p>其实tree就是我们理解数据结果的那个tree，tree的中间节点指向其它的tree，叶子节点指向blob</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/865c3e3886016dc7c722d039e5b1e89f/3658a/image-20191212175640772.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.7217847769029%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACMklEQVQ4y42T6W8SQRjG+auNmjTlD9CQygdJGmPUVNPoB2Ip5VoWWO5DKKU0tiZWKHLfe9A9eJyZhSVcsW+y2d1nZn7zvs87Y8OOmM/n7G1oGlrtNjRVXdPpe/m9GbZ9MJ1ATkM8HD4en4M8+38KdAtoLCbVGw28Og/hOFWEIxBD+kdpbdN9YNvmpOWgIst47wvBlSjA5fGjSUpv9fuYiBL2rSEf68DNHX/X6iheVdDqdDAWRaZ1h0O0Cdgw5htWGdslr1Kf4/5PDc1uzxpr9gYYjkTSIAPKo4ZGu4PRVMaUPLOZZq3fynCmKHALKbzxhsBlcmTA3LlcLcPjdUCIuNBs1pkWiPjBBR2Ix96h2+2sMqQwwzAX5kmJR1wcb4UcXru9kCURdKuE8Akx7gDh4Eukk6eQFaLFjpGI2uE7f4Z8zrMbWHt4wBHJzhnN4EMgDHWmMD2XvYDAHyLK2XFZ4pmWjH9lwHDAjmo1awJppUtDaYwmUxQq1+CzedKUmmWHquqoXKVQvc5C08z5MknzsiTg9mcJi3wo0PRuOlVw32ijP55Y8L/dMSRFtxq1u4HrGiv5110ZUd4J95kTfXIkaAwGfYQjJ+D4j+j1TMN1XSOZ6GtHjP5Tu5aaTZIeidFO5k/w4jkKeZ/lD+d/ASF8ACF2At0ws9x3h62bouu0g1+IuYcEYMfNTZ4NZNJnrKNUTyW/weQ8AWj6J6JU5HF3uzJXkmRyFLzIZr5jvPD1fzAa/wCjGGW4WbshJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20191212175640772\"\n        title=\"image-20191212175640772\"\n        src=\"/blog/static/865c3e3886016dc7c722d039e5b1e89f/b9e4f/image-20191212175640772.png\"\n        srcset=\"/blog/static/865c3e3886016dc7c722d039e5b1e89f/cf440/image-20191212175640772.png 148w,\n/blog/static/865c3e3886016dc7c722d039e5b1e89f/d2d38/image-20191212175640772.png 295w,\n/blog/static/865c3e3886016dc7c722d039e5b1e89f/b9e4f/image-20191212175640772.png 590w,\n/blog/static/865c3e3886016dc7c722d039e5b1e89f/3658a/image-20191212175640772.png 762w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>其它优化</h4>\n<ol>\n<li>如果git仓库中的存在文件出现多次，比如file-A被拷贝到dir-B/fiel-C，那么这个文件在git里面只会被保存一次，因为它的文件内容是一样，不一样的只是文件名以及文件位置，只要把这些信息保存在tree里面，就可以定位到具体的内容</li>\n<li>git object 是压缩后的数据，如果 object 过多，git 会把资源数据打包成有个 Packfile，Packfile 保存文件内容，以及每次增量更新的修改。</li>\n</ol>\n<h3>commit</h3>\n<p>每次的commit都指向一个tree，并且包含一些头信息</p>\n<ul>\n<li>代码修改者以及提交者</li>\n<li>日期</li>\n<li>commit message</li>\n<li>当前commit的上一次提交，如果是merge操作，可能会有多个parent commit</li>\n</ul>\n<p>git 会根据以上信息计算一个sha1，作为commit的唯一key </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/7dde43f18042d5cf873ed65f00873500/b2a12/image-20191213162249523.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 109.84126984126985%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAAEAElEQVQ4y5VVa08bRxT1f+ynSk2lSqlSqZASggF77fVrd722MdgGE6wmLQkJCdhporYQg/GLUvwINMaOedmG9PWl+ZJKNDQKcHrveF0c2g/tWlczs7Nz5px7z4xNoOfV76/wx/FrvD15i9fHx/jzzRuc0e/k9OQ/xenpKcPg7OwMJu7UKzUkHsSRSqaQT+dQLmzg/z4Mxo/p4MUhZp7cw1Qihsj9KG7EY4jOT2F6YQbx3EPcX57Dg5V5zGUSmEvH25GJi/F89iFmlmZReFYUYMzUlFpbwbVVK9TmKJQGRxCuHT/sWxqcOz58HO9BX9oCR12HbUuFvapCrmmQKor4pr8sIbZ0SwCyfFO+tAqp6MHVR2Z8EP4I76nv41L0Mj6kUOtj6F+wQC6q0OoRDKV1SGt+WPN+eHfDCDQn4Nz2407+ngFIDHOlPBwVHc4fdFjyLgzlnLCuuWEnkODPN3B9SYJj0wt9PwpbYQT2UhC29SD8BxMI/jgJd2MEd76bPQfMrGXwSaIPgxkZQ1mHCHPajoGUjfoyLk1expXZq+13y1bawEqthP4ktUkJVx5/htg3N88lZ77PoufrAQznnQKUg/sMzH3zir29Wa69mVBhbGwhNb1LZny++MU5YK6Yh7Pqw9ivU5SXMQFgWXUh8CKKQGsCgcN2BH+ahK2ooP+JFf2LFkqRD6FfYnDvk+TVrhxmiznYygrlKAylHoR7KwDnMx+0nTFo2xyjUCl47KmNwLmpw1XxU8FGoe+FqfIaprMz5wwZUCopYlIEAfsaEWIbglILQn0eFMAM4N0LiTl/cxxe2sC7HRLWmc50AxZysG9o4kOurjkti4IwSwZgYC9v0oxQhVXhAs4xs+SUyOTP27m7FwFVsdhWILOWNdF6qiMCTEin3DIgW0ta90CieXc1AH9jHPaaF9PdgFwUiXLIi1lKJ3gDpdqWzHJZNqeD5xhcMyTbKirl8G6XsbkoTxUh2UWVk8teOJ56oXDumJ3BkMG4KDIp4MKo9J5zLhPDf0re1OBvjQsjDyzbRA7dJJkXtHMYgt4IC6uwodmDKjHmo8c5vCDZsA0vJpnMhIP7Wt2wzm6baWee1ejcp/Nsr17IobCNAaiQJJbKfuxYxV0JCG+yXJ7nYolvqK8+H4V104NbqdvvSpZJskIf9nxFR5CO2KeJ6+j7dliwcW7ouEY3jpnSMJjmoyhDLmnofWymG2oQvUkzbia/fJehXPHSUZuArxURoe1Rwptt7/FY9I220+fwH4zDseuj26b76K3n0PuImGXIsCt06DnSRpuiy8IInhvuvCeW3FrSdDksEMPFLoZHR0dotppoHbbQOmhH04jucevfxrRmv9nAby9f/v2/8hcC6E4BVDEE0gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20191213162249523\"\n        title=\"image-20191213162249523\"\n        src=\"/blog/static/7dde43f18042d5cf873ed65f00873500/b9e4f/image-20191213162249523.png\"\n        srcset=\"/blog/static/7dde43f18042d5cf873ed65f00873500/cf440/image-20191213162249523.png 148w,\n/blog/static/7dde43f18042d5cf873ed65f00873500/d2d38/image-20191213162249523.png 295w,\n/blog/static/7dde43f18042d5cf873ed65f00873500/b9e4f/image-20191213162249523.png 590w,\n/blog/static/7dde43f18042d5cf873ed65f00873500/b2a12/image-20191213162249523.png 630w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>每个commit都是当前代码的一次快照</p>\n<p>可以通过一下操作验证</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 打印objects下的文件</span>\ntree .git/objects\n\nobjects/\n├── 4b\n│   └── 825dc642cb6eb9a060e54bf8d69288fbee4904\n├── 9d\n│   └── aeafb9864cf43055ae93beb0afd6c7d144bfa4\n├── 9e\n│   └── a265b576f105b3c7515c691fd6bd2d202d68a8\n├── c0\n│   └── 7b19257d9414174748d121caf7e6e09c753a6b\n├── info\n└── pack\n\n<span class=\"token comment\"># 通过git cat-file -t 找到上次commit提交的sha1</span>\n<span class=\"token function\">git</span> cat-file -t 9ea265\ncommit\n\n<span class=\"token comment\"># 查看上次commit的信息</span>\n<span class=\"token function\">git</span> cat-file -p 9ea265\n\ntree c07b19257d9414174748d121caf7e6e09c753a6b\nauthor feikerwu <span class=\"token operator\">&lt;</span>feikerwu@gmail.com<span class=\"token operator\">></span> <span class=\"token number\">1576226621</span> +0800\ncommitter feikerwu <span class=\"token operator\">&lt;</span>feikerwu@gmail.com<span class=\"token operator\">></span> <span class=\"token number\">1576226621</span> +0800\n\ninit\n\n<span class=\"token comment\">## 可以看到一个commit的包含的所有信息</span></code></pre></div>\n<h3>references</h3>\n<p>head, 标签以及分支都只是一个commit的引用，或者别名。引用信息存储在 <code class=\"language-text\">.git/refs</code> 文件夹下</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">tree .git/refs\n.git/refs\n├── heads\n│   ├── master\n│   └── <span class=\"token builtin class-name\">test</span>\n└── tags\n    └── tag-1\n    \n\n<span class=\"token function\">git</span> log --oneline \n9ea265b <span class=\"token punctuation\">(</span>HEAD -<span class=\"token operator\">></span> master, tag: tag-1, <span class=\"token builtin class-name\">test</span><span class=\"token punctuation\">)</span> init\n\n<span class=\"token comment\"># 查看文件内容</span>\n<span class=\"token function\">cat</span> .git/refs/heads/master\n9ea265b576f105b3c7515c691fd6bd2d202d68a8</code></pre></div>\n<p>通过以上，可以看到refs/heads/master 存储hash值和当前commit hash值相同</p>\n<h4>标签 tag</h4>\n<p>git tag 给某个commit打标签，用于快速或检出有里程碑意义的commit。注意，tag确定，其指向的commit就不会变。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 给最新的提交添加一个tag</span>\n<span class=\"token function\">git</span> tag <span class=\"token variable\"><span class=\"token variable\">`</span>tag-name<span class=\"token variable\">`</span></span>\n\n<span class=\"token comment\"># 给某个特定的commit添加一个tag</span>\n<span class=\"token function\">git</span> tag <span class=\"token variable\"><span class=\"token variable\">`</span>tag-name<span class=\"token variable\">`</span></span> <span class=\"token variable\"><span class=\"token variable\">`</span>hash<span class=\"token punctuation\">{</span><span class=\"token number\">8</span><span class=\"token punctuation\">}</span><span class=\"token variable\">`</span></span>\n\n<span class=\"token comment\"># 给最新的提交添加一个tag，并且添加一些信息</span>\n<span class=\"token function\">git</span> tag <span class=\"token variable\"><span class=\"token variable\">`</span>tag-name<span class=\"token variable\">`</span></span> -m <span class=\"token variable\"><span class=\"token variable\">`</span>message<span class=\"token variable\">`</span></span></code></pre></div>\n<h4>分支 branch</h4>\n<p>branch 也是commit的引用，和tag不同的是，branch指向的commit会随着提交更新</p>\n<h3>Tips</h3>\n<ol>\n<li>\n<p>如果有人在本地误操作将某条分支删除，并且没有推送到远程仓库，如何恢复</p>\n<p>注意到，分支只是commit的一个引用，只要commit没有被删除，提交内容都可以恢复 ，具体操作 如下</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">## 列出所有分支的提交记录，找到被删除分支的commit</span>\n<span class=\"token function\">git</span> relog \n<span class=\"token comment\">## 签出恢复</span>\n<span class=\"token function\">git</span> checkout <span class=\"token variable\"><span class=\"token variable\">`</span>找到的commit<span class=\"token variable\">`</span></span></code></pre></div>\n</li>\n<li>列出所有已经合入到 master 的分支<code class=\"language-text\">git branch —merged master</code></li>\n<li>列出所有没有合入到 master 的分支 <code class=\"language-text\">git branch --no-merged maste</code></li>\n</ol>\n<h5>参考</h5>\n<p><a href=\"https://git-scm.com/book/zh/v2/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Git-%E5%AF%B9%E8%B1%A1\">Git-内部原理-对象</a></p>","frontmatter":{"title":"深度理解git","date":"December 11, 2019","description":"深入探索git底层原理以及常用操作"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/git-in-deepth/","previous":{"fields":{"slug":"/worker/"},"frontmatter":{"title":"worker 在浏览器中的作用"}},"next":{"fields":{"slug":"/big-file/"},"frontmatter":{"title":"大文件数据排序"}}}}}